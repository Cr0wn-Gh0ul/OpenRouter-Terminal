name: Build, Release & Publish

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x64
            docker_platform: linux/amd64
          - arch: arm64
            docker_platform: linux/arm64
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build CJS bundle
        run: npm run build:cjs
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Build SEA in Docker
        run: |
          mkdir -p bin
          docker run --rm --platform ${{ matrix.docker_platform }} \
            -v "$PWD":/app \
            -w /app \
            node:22-bookworm-slim \
            sh -c "node --experimental-sea-config sea-config.json && \
                   cp \$(command -v node) /app/bin/openrouter-linux-${{ matrix.arch }} && \
                   npx -y postject /app/bin/openrouter-linux-${{ matrix.arch }} NODE_SEA_BLOB sea-prep.blob \
                       --sentinel-fuse NODE_SEA_FUSE_fce680ab2cc467b6e072b8b5df1996b2 && \
                   chmod +x /app/bin/openrouter-linux-${{ matrix.arch }}"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openrouter-linux-${{ matrix.arch }}
          path: bin/openrouter-linux-${{ matrix.arch }}
          retention-days: 1

  build-macos:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: x64
            runner: macos-15-intel
          - arch: arm64
            runner: macos-15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build SEA
        run: npm run build:sea
      
      - name: Rename binary
        run: mv bin/openrouter-* bin/openrouter-darwin-${{ matrix.arch }}
      
      - name: Code sign (ad-hoc)
        run: codesign --sign - --force bin/openrouter-darwin-${{ matrix.arch }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openrouter-darwin-${{ matrix.arch }}
          path: bin/openrouter-darwin-${{ matrix.arch }}
          retention-days: 1

  publish-npm:
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos]
    permissions:
      contents: read
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm
        run: npm install -g npm@latest
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Publish to npm
        run: npm publish

  create-release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bin/
          merge-multiple: true
      
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Create checksums
        run: |
          cd bin
          sha256sum openrouter-* > SHA256SUMS.txt
          cat SHA256SUMS.txt
      
      - name: List artifacts
        run: ls -la bin/
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
          generate_release_notes: true
          files: |
            bin/openrouter-linux-x64
            bin/openrouter-linux-arm64
            bin/openrouter-darwin-x64
            bin/openrouter-darwin-arm64
            bin/SHA256SUMS.txt

